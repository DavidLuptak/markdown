\documentclass{beamer}
\usetheme[faculty=fi]{fibeamer}

% Localization
\usepackage{polyglossia}
\setmainlanguage{english}

% Markdown setup
\usepackage[
  hybrid,
  footnotes,
  fencedCode,
  citations,
  definitionLists,
]{markdown}
\markdownSetup{
  renderers = {
    emphasis = {\alert{#1}},
    headingOne = {\section{#1}},
    headingTwo = {\subsection{#1}},
    headingThree = {\frametitle{#1}},
    headingFour = {\framesubtitle{#1}},
    footnote = {\footnote[frame]{#1}},
  }
}

% Bibliography setup
\usepackage{filecontents}
\begin{filecontents}{main.bib}

@BOOK{knuth86,
  author        =   {Knuth, Donald Ervin},
  year          =   {1986},
  title         =   {The \TeX book},
  edition       =   {3},
  isbn          =   {0-201-13447-0},
  pagetotal     =   {ix, 479},
  publisher     =   {Addison-Westley},
  langid        =   {english},
  url           =   {https://mirrors.ctan.org/systems/knuth/dist/tex/texbook.tex},
  urldate       =   {2016-11-08},
}

@ARTICLE{carliste00,
  author        =   {David Carlisle},
  year          =   {2000},
  title         =   {XML\TeX},
  subtitle      =   {A non-validating (and not 100\% conforming) namespace-aware XML parser implemented in \TeX},
  journaltitle  =   {TUGboat},
  volume        =   {21},
  number        =   {3},
  urldate       =   {2016-11-08},
  url           =   {https://www.tug.org/TUGboat/tb21-3/tb68carl.pdf},
  pages         =   {193--199},
  issn          =   {0896-3207},
  langid        =   {english},
}

@INPROCEEDINGS{ford02,
  author        =   {Bryan Ford},
  year          =   {2002},
  title         =   {Packrat Parsing},
  subtitle      =   {Simple, powerful, lazy, linear time, functional pearl},
  booktitle     =   {ACM SIGPLAN Notices},
  volume        =   {37},
  number        =   {9},
  organization  =   {ACM},
  pages         =   {36--47},
  urldate       =   {2016-11-08},
  url           =   {http://bford.info/pub/lang/packrat-icfp02.pdf},
  doi           =   {10.1145/581478.581483},
  langid        =   {english},
}

@INPROCEEDINGS{ford04,
  author        =   {Bryan Ford},
  year          =   {2004},
  title         =   {Parsing expression grammars},
  subtitle      =   {A recognition-based syntactic foundation},
  booktitle     =   {ACM SIGPLAN Notices},
  volume        =   {39},
  number        =   {1},
  organization  =   {ACM},
  pages         =   {111--122},
  urldate       =   {2016-08-16},
  url           =   {https://pdos.csail.mit.edu/papers/parsing:popl04.pdf},
  doi           =   {10.1145/964001.964011},
  langid        =   {english},
}

@ONLINE{gruber04,
  author        =   {John Gruber},
  year          =   {2004},
  title         =   {Markdown},
  urldate       =   {2016-08-15},
  url           =   {https://daringfireball.net/projects/markdown/}, 
  langid        =   {english},
}

@ARTICLE{dominici14,
  author        =   {Massimiliano Dominici},
  year          =   {2014},
  title         =   {An overview of Pandoc},
  journaltitle  =   {TUGboat},
  volume        =   {35},
  number        =   {1},
  urldate       =   {2016-08-15},
  url           =   {http://tug.org/TUGboat/tb35-1/tb109dominici.pdf},
  pages         =   {44--50},
  issn          =   {0896-3207},
  langid        =   {english},
}

@ONLINE{macfarlane16-1,
  author        =   {John MacFarlane},
  year          =   {2016},
  title         =   {Pandoc},
  subtitle      =   {a universal document converter},
  urldate       =   {2016-08-15},
  url           =   {http://pandoc.org/}, 
  langid        =   {english}}

@ONLINE{macfarlane16-2,
  author        =   {John MacFarlane},
  year          =   {2016},
  title         =   {Lunamark},
  subtitle      =   {Lua library for conversion between markup formats},
  urldate       =   {2016-08-15},
  url           =   {https://github.com/jgm/lunamark}, 
  langid        =   {english}}

@ONLINE{luateam16,
  author        =   {{Lua Team}},
  year          =   {2016},
  title         =   {Lua},
  subtitle      =   {About},
  urldate       =   {2016-08-15},
  url           =   {https://www.lua.org/about.html},
  langid        =   {english}}

@ONLINE{luatex16,
  author        =   {{Lua\TeX{} Team}},
  year          =   {2016},
  title         =   {Lua\TeX},
  subtitle      =   {Welcome},
  urldate       =   {2016-08-15},
  url           =   {http://luatex.org/},
  langid        =   {english}}

@ONLINE{overleaf16,
  author        =   {{Overleaf}},
  year          =   {2016},
  title         =   {Two great examples of how to use \#markdown with @Overleaf
                     -- thanks @liantze!},
  urldate       =   {2016-08-15},
  url           =   {https://twitter.com/overleaf/status/763395560682364928},
  langid        =   {english}}

@BOOK{downey16,
  author        =   {Downey, Allen B. and Mayfield, Chris},
  year          =   {2016},
  title         =   {Think Java},
  subtitle      =   {How to Think Like a Computer Scientist},
  version       =   {6.1.0},
  pagetotal     =   {xviii, 273},
  publisher     =   {Green Tea Press},
  langid        =   {english},
  url           =   {http://thinkjava.org/},
  urldate       =   {2016-11-08},
}

@BOOK{gillespie16,
  author        =   {Gillespie, Colin and Lovelace, Robin},
  year          =   {2016},
  title         =   {Efficient R programming},
  isbn          =   {978-1-4919-5078-4},
  pagetotal     =   {204},
  publisher     =   {O'Reilly Media},
  langid        =   {english},
  url           =   {https://github.com/hadley/r4ds/},
  urldate       =   {2016-11-08},
}

@BOOK{grolemund16,
  author        =   {Grolemund, Garrett and Wickham, Hadley},
  year          =   {2016},
  title         =   {R for Data Science},
  isbn          =   {978-1-4919-1039-9},
  pagetotal     =   {518},
  publisher     =   {O'Reilly Media},
  langid        =   {english},
  url           =   {https://github.com/hadley/r4ds/},
  urldate       =   {2016-11-08},
}

@MANUAL{l3proj16,
  author        =   {{\LaTeX3 Project}},
  date          =   {2016-10-19},
  title         =   {The l3regex package},
  subtitle      =   {regular expressions in \TeX},
  urldate       =   {2016-11-08},
  url           =   {http://mirrors.ctan.org/macros/latex/contrib/l3experimental/l3regex.pdf},
  langid        =   {english}}

@ONLINE{novotny16-1,
  author        =   {Novotný, Vít},
  year          =   {2016},
  title         =   {Markdown},
  subtitle      =   {A package for converting and rendering markdown documents
                     inside \TeX{}},
  urldate       =   {2016-08-15},
  note          =   {Available from: \url{http://ctan.org/pkg/markdown},
                     \url{https://github.com/Witiko/markdown}, and
                     \url{https://gitlab.fi.muni.cz/xnovot32/markdown}},
  langid        =   {english}}

@MANUAL{novotny16-2,
  author        =   {Novotný, Vít},
  year          =   {2016},
  title         =   {A Markdown Interpreter for \TeX{}},
  url           =   {http://mirrors.ctan.org/macros/generic/markdown/markdown.pdf},
  urldate       =   {2016-08-17},
  langid        =   {english}}

@ONLINE{novotny16-3,
  author        =   {Novotný, Vít},
  year          =   {2016},
  title         =   {Added support for Pandoc-style citations},
  urldate       =   {2016-08-15},
  url           =   {https://github.com/jgm/lunamark/pull/20},
  langid        =   {english}}

@ARTICLE{fenn16,
  author        =   {Jürgen Fenn},
  year          =   {2016},
  title         =   {Neue Pakete auf CTAN},
  journaltitle  =   {Die \TeX nische Komödie},
  number        =   {3/2016},
  issn          =   {1434-5897},
  langid        =   {german},
}

\end{filecontents}
\usepackage[
  backend=biber,
  style=iso-authoryear,
  sorting=nty,
  autolang=other,
  sortlocale=auto,
]{biblatex}
\addbibresource{main.bib}

% Miscellaneous packages and other setup
\ifx\ifdarkframes\undefined
  \expandafter\newif\csname ifdarkframes\endcsname
  \darkframestrue
\fi
\usepackage{minted}
\usemintedstyle{\ifdarkframes monokai\else murphy\fi}
\frenchspacing
\usepackage{pgffor}
\newcommand\becomes{%
  \vspace{1ex}%
  \foreach\n in {1,...,30}{%
    \textdownarrow
  }%
  \vspace{1ex}%
}

% Metadata
\title{
  A \texorpdfstring{%
    \raisebox{-1.7mm}{\includegraphics[scale=0.2]{markdown-mark}}%
  }{Markdown}\ Interpreter for \TeX}
\subtitle{%
  Project MUNI 33 / 12 2015
  \texorpdfstring{\url{https://github.com/witiko/markdown}}{}%
}
\author{Vít Novotný}
\begin{document}
\frame{\maketitle}
\AtBeginSection[]{\frame{\sectionpage}}

\ifdarkframes
\begin{darkframes}
\fi

\begin{frame}{\contentsname}
  \tableofcontents
\end{frame}

\markdownBegin
# Introduction
## The Case for Lightweight Markup

\begin{frame}

### \subsecname
#### What is Wrong with \TeX?

  1. High Markup to Text Ratio
    * @knuth86 is 22\,\% markup.
    * @downey16 is 21\,\% markup.
  2. Zero Sandboxing Support
    * The document you are typesetting may not compile.
      ```tex
      … a file named \texttt{evil_underscores.tex} …
      ```
    * The document you are typesetting may halt.
      ```tex
      \def\whiletrue{\whiletrue} \whiletrue
      ```
    * The document you are typesetting may access the system shell.
      ```tex
      \immediate\write18{sudo rm -rf /}
      ```
  3. Steep Learning Curve

\end{frame}
\iffalse
\begin{frame}

### \subsecname
#### The Language of Markdown

> The overriding design goal for Markdown’s formatting syntax is to make it
> *as readable as possible*. The idea is that a Markdown-formatted document
> should be _publishable as-is, as plain text_, without looking like it’s been
> marked up with tags or formatting instructions. While Markdown’s syntax has
> been influenced by several existing text-to-HTML filters, the single
> biggest source of inspiration for Markdown’s syntax is *the format of plain
> text email*.

\hfill --- @gruber04, emphasis mine

\end{frame}
\fi
\begin{frame}

### \subsecname
#### Comparison of \LaTeX{} and Markdown

\footnotesize
```tex
\section{This is a level one heading}
This is a text paragraph with \emph{emphasis}.
\begin{quotation}This paragraph will show as a quote.\end{quotation}
\begin{verbatim}
This is is a source code example.
\end{verbatim}
\begin{itemize}
  \item First item with \alert{strong emphasis}
  \item Second item with a link%
    \footnote{See \url{http://link.com} (Title)}
\end{itemize}
\begin{enumerate}
  \item First item with \verb`inline code`.
  \item Second item with an \includegraphics{image.png}
\end{enumerate}
```

\end{frame}
\begin{frame}

### \subsecname
#### Comparison of \LaTeX{} and Markdown

```markdown
# This is a level one heading
This is a text paragraph with _emphasis_.
> This paragraph will show as a quote.

␣␣␣␣This is is a source code example.

* First item with **strong emphasis**
* Second item with a [link](http://link.com/ "Title")

1. First item with `inline code`.
2. Second item with an ![image](image.png "Title")
```

\end{frame}
\begin{frame}

### \subsecname
#### How is Markdown Useful?

  1. Minimal Markup to Text Ratio
    * Recall: @knuth86 and @downey16 are _\textasciitilde 22\,\% markup_.
    * @gillespie16 is 5.5\,\% markup.
    * @grolemund16 is 3.8\,\% markup.
  2. Sandboxing Support
    * A Markdown document converted to \TeX{} will always compile.
    * The document may neither halt nor access the shell.
  3. Hybrid Markup Support
    * Markdown was designed to supplement HTML, not replace it.
    * Structurally simple sections can use pure Markdown, complex sections
      may combine Markdown and the host markup.
  4. Mild Learning Curve

\end{frame}

## Existing Solutions

\begin{frame}

### \subsecname
#### The Swiss Army Knife of Pandoc

> If you need to _convert files from one markup format into another_,
> Pandoc is your swiss-army knife.

\hfill --- @macfarlane16-1, emphasis mine

  * A multi-target publishing software.
  * Supports tens of markup languages (Markdown, \LaTeX, HTML, XML Docbook)
    and output formats (ODF, OOXML, PDF).
  * The use of Pandoc for the preparation of \LaTeX{} documents has been
    described by @dominici14\.

\end{frame}
\begin{frame}

### \subsecname
#### What is Wrong with Pandoc?

  1. No Way to Change Output Markup
    ```markdown
    # Heading {#link}
    This is [a link](#link).
    ```
    \becomes
    ```tex
    \hypertarget{link}{\section{Heading}\label{link}}
    This is \protect\hyperlink{link}{a link}.
    ```
  2. Not a Part of \TeX{} Distributions
    * Markdown documents cannot be directly edited at collaborative \TeX{}
      platforms such as Share\LaTeX{} or Overleaf.

\end{frame}
\begin{frame}

### \subsecname
#### What is Wrong with Pandoc?

  3. Half-hybrid, Half-sandboxed
    * The input is heuristically parsed and sanitized:
      ```tex
      This {will} 2^n \begin{get} s~nitized and \this{will}
      not \begin{equation}2^n\end{equation} $2^n$.
      ```
      \becomes
      ```tex
      This \{will\} 2\^{}n \textbackslash{}begin\{get\}
      s\textasciitilde{}nitized and \this{will} not
      \begin{equation}2^n\end{equation} \(2^n\).
      ```
    * Malicious input such as
      ```tex
      \def\shell{18} \immediate\write\shell{sudo rm -rf /}
      ```
      is left alone by Pandoc.

\end{frame}

# The Markdown Package
## Building a Parser

\begin{frame}

### \subsecname
#### Is \TeX{} Up to the Task?

There exist formal language parsers written solely in \TeX. These parsers
recognize regular [@l3proj16] and context-free LL(1) languages [@carliste00].
Markdown is not context-free:
```
``There is a literal backtick (`) here.``
```
and a parser needs to be able to backtrack over the entire input:
```
[this is not a link](http://link.com/ "Title"
```

Implementing a recursive-descent parser with backtracking in \TeX{} is
possible, but generally a bad idea:

  * Difficult to Maintain, Highly Unidiomatic
  * Lack of Efficient Data Structures

\end{frame}
\begin{frame}

### \subsecname
#### Can We Use Lua Instead of \TeX?

> Lua is a powerful, efficient, lightweight, embeddable scripting language. It
> supports procedural programming, object-oriented programming, functional
> programming, data-driven programming, and data description. 

\hfill --- @luateam16
\vfill

> Lua\TeX{} is an extended version of pdf\TeX{} using Lua as an embedded
> scripting language.

\hfill --- @luatex16

\end{frame}
\begin{frame}

### \subsecname
#### Can We Use Lua Instead of \TeX?

  * With Lua\TeX, we can directly execute Lua code:
    ```tex
    1 + 2 = \directlua{ tex.sprint(1 + 2) }
    ```
  * With pdf\TeX{} and other modern \TeX{} engines, we can spawn a shell and
    execute the Lua code in a separate process:
    ```tex
    1 + 2 = \newwrite\script
    \immediate\openout\script=script.lua
    \immediate\write\script{ print(1 + 2) }%
    \immediate\closeout\script
    \immediate\write18{texlua script.lua > output.tex}%
    \input output.tex
    ```

\end{frame}
\begin{frame}

### \subsecname
#### The Lunamark Library

  * Lunamark [@macfarlane16-2] is a Markdown parser for Lua.
  * The language is specified using a Parsing Expression Grammar
    (PEG) via the LPeg C library (with some cheating).
    * PEGs are CFGs with ordered choice; as a corrolary, any PEG is
      unambiguous. [@ford04] The parse tree for any PEG $G$ and an input word
      $u$ can be computed in linear time relative to $|u|$ via „packrat
      parsing“. [@ford02] PEGs${}\subset{}$CFGs is conjectured.
  * The dependencies of Lunamark were all either compiled into Lua\TeX{}
    (LPeg, Slnunicode), or unneeded (Cosmo, Alt-getopt).
  * The library has been released under the Expat (MIT) License.

\end{frame}
\begin{frame}

### \subsecname
#### The Lunamark Library

The modified version of Lunamark:

  * produces a parse tree rather than presentation markup:
    ```markdown
    # Heading
    This is [a link](#link).
    ```
    \becomes
    ```tex
    \markdownRendererHeadingOne{Heading}
    This is \markdownRendererLink{a link}{#link}{#link}{}.
    ```

The Markdown \TeX{} package:

  * converts a Markdown document to the parse tree via Lunamark,
  * defines the macros and typesets the parse tree using \TeX{}.

\end{frame}

## Using Markdown from Within \LaTeX

\begin{frame}

### \subsecname
#### The Sandbox and Hybrid Modes

```tex
\documentclass{article}
\usepackage{markdown}
\begin{document}
\begin{markdown}
  Foo bar \TeX{} $2^n$.
\end{markdown}
\begin{markdown*}{hybrid}
  Foo bar \TeX{} $2^n$.
\end{markdown*}
\end{document}
```

Foo bar \markdownRendererBackslash TeX\markdownRendererLeftBrace{}\markdownRendererRightBrace{} \markdownRendererDollarSign{}2\markdownRendererCircumflex{}n\markdownRendererDollarSign{}. Foo bar \TeX{} $2^n$.

\end{frame}
\begin{frame}

### \subsecname
#### Mapping Markdown Tokens to \TeX{} Macros

```tex
\documentclass{article}
\usepackage{markdown}
\markdownSetup{renderers = {
  link = {#1\footnote{See \url{#3} (#4)}},
}}
\begin{document}
\begin{markdown}
  Foo [bar](http://link.com "Link").
\end{markdown}
\end{document}
```

Foo bar\footnote[frame]{See \url{http://link.com} (Link)}.

\end{frame}
\begin{frame}

### \subsecname
#### Syntax Extensions

  * Some syntax extensions were already supported by Lunamark:
    * footnotes,
    * definition lists,
  * New syntax extensions were added as a part of the project:
    * citations,
    * fenced code blocks.

\end{frame}
\begin{frame}

### \subsecname
#### Syntax Extensions -- `\markdownSetup{footnotes}`

```tex
Here is a footnote reference,[^1] and another.[^long]

[^1]: Here is the footnote.

[^long]: Here’s one with multiple blocks.

    Subsequent paragraphs are indented to show that
they belong to the footnote.
```

\vfill
  
Here is a footnote reference,[^1] and another.[^long]

[^1]: Here is the footnote.

[^long]: Here’s one with multiple paragraphs.

    Subsequent paragraphs are indented to show that
they belong to the footnote.

\end{frame}
\begin{frame}

### \subsecname
#### Syntax Extensions -- `\markdownSetup{definitionLists}`

```tex
Term 1
:   Definition

Term 2
:   Definition with

    multiple paragraphs
```

\vfill
  
Term 1
:   Definition 1

Term 2
:   Definition

    with multiple paragraphs

\end{frame}
\begin{frame}

### \subsecname
#### Syntax Extensions -- `\markdownSetup{citations}`

```tex
Here is a parenthetical citation [@knuth86] and
a string of several [see @knuth86, pp. 33-35;
also @gruber04, chap. 1].

Here is a text citation @knuth86 and a string of
several @knuth86 [pp. 33-35; @gruber04, chap. 1].
```

\vfill
  
Here is a parenthetical citation [@knuth86] and
a string of several [see @knuth86, pp. 33-35;
also @gruber04, chap. 1].

Here is a text citation @knuth86 and a string of
several @knuth86 [pp. 33-35; @gruber04, chap. 1].

\end{frame}
\begin{frame}

### \subsecname
#### Syntax Extensions -- `\markdownSetup{fencedCode}`

```
~~~ js
if (a > b)
  return c + 4;
else
  return d + 5;
~~~~~~
```

\vfill

~~~ js
if (a > b)
  return c + 4;
else
  return d + 5;
~~~~~~

\end{frame}

# Conclusion

\begin{frame}

### \secname
#### The Missing Pieces of the Puzzle

 * Apart from the \LaTeX{} interface, the package also exposes Lua, plain
   \TeX{} and Con\TeX t interfaces.
 * The package includes 82 pages of user and technical documentation.
   [@novotny16-2]
 * A section on writing \LaTeX{} documents in Markdown was added to the
   fithesis3 sample documents.
 * The package was released under the \LaTeX{} Project Public License (LPPL)
   1.3 on the Comprehensive \TeX{} Archive Network (CTAN), GitHub, and the
   faculty GitLab. [@novotny16-1] It is available in updated \TeX{} Live
   2016.

\end{frame}
\begin{frame}

### \secname
#### Reception by the Community

  * The syntax extensions were backported to Lunamark and merged by MacFarlane,
    resulting in a new minor version release of the library (0.5.0).
    [@novotny16-3]
  * The package was featured on the twitter profile of Overleaf -- a major
    online service for preparing \LaTeX{} documents -- along with original
    example documents. [@overleaf16]
  * The package was reviewed in the bulletin of the German \TeX{} Users Group
    (DANTE e.V.). [@fenn16, pp. 43]
  * An article about the package has been accepted for publication in the
    bulletin of the Czechoslovak \TeX{} Users Group (CSTUG).

\end{frame}

# Bibliography

\begin{frame}[allowframebreaks]
### \secname
\nocite{*}
\printbibliography
\end{frame}

\markdownEnd
\ifdarkframes
\end{darkframes}
\fi
\end{document}
